---
layout: post
title: Topten Software - petapoco
date: '2011-12-28T01:29:00.001Z'
author: solrevdev
tags: 
modified_time: '2011-12-28T01:29:05.737Z'
blogger_id: tag:blogger.com,1999:blog-31446756.post-3774241800387960515
blogger_orig_url: http://www.solrevdev.com/2011/12/topten-software-petapoco.html
---

<div class='posterous_autopost'><div class="posterous_bookmarklet_entry"> <blockquote><div>          	<div>    <h3>PetaPoco</h3>  <ul>  	<li><a href="http://www.toptensoftware.com/petapoco#">Main</a></li>   	<li><a href="http://www.toptensoftware.com/petapoco#">Documentation</a></li>   	<li><a href="http://www.toptensoftware.com/petapoco#">License</a></li>   </ul>  </div>  <h3>PetaPoco</h3>  <h3>  </h3><p>A tiny ORM-ish thing for your POCOs</p>    <p>PetaPoco is a tiny, fast, single-file micro-ORM for .NET and Mono.</p>  <ul>  <li>Like <a href="http://blog.wekeroad.com/helpy-stuff/and-i-shall-call-it-massive" target="_blank">Massive</a> it's a single file that you easily add to any project</li>  <li>Unlike <a href="http://blog.wekeroad.com/helpy-stuff/and-i-shall-call-it-massive" target="_blank">Massive</a> it works with strongly typed <a href="http://en.wikipedia.org/wiki/Plain_Old_CLR_Object" target="_blank">POCO</a>'s</li>  <li>Like <a href="http://blog.wekeroad.com/helpy-stuff/and-i-shall-call-it-massive" target="_blank">Massive</a>, it now also supports dynamic Expandos too - <a href="http://www.toptensoftware.com/Articles/104/PetaPoco-Not-So-Poco-or-adding-support-for-dynamic" target="_blank">read more</a></li>  <li>Like <a href="http://ar.rubyonrails.org/" target="_blank">ActiveRecord</a>, it supports a close relationship between object and database table</li>  <li>Like <a href="http://www.subsonicproject.com" target="_blank">SubSonic</a>, it supports generation of poco classes with T4 templates</li>  <li>Like <a href="http://code.google.com/p/dapper-dot-net/" target="_blank">Dapper</a>, it's fast because it uses dynamic method generation (MSIL) to assign column values to properties</li>  </ul>  <h3>Background</h3>  <p>PetaPoco was original inspired by Rob Conery's <a href="http://blog.wekeroad.com/helpy-stuff/and-i-shall-call-it-massive" target="_blank">Massive</a> project but for use with non-dynamic <a href="http://en.wikipedia.org/wiki/Plain_Old_CLR_Object" target="_blank">POCO</a> objects.  It came about because I was finding many of my projects that used SubSonic/Linq were slow or becoming mixed bags of Linq and <a href="http://www.subsonicproject.com/docs/CodingHorror" target="_blank">CodingHorror</a>.</p>  <p>I needed a data acess layer that was tiny, fast, easy to use and could run on .NET 3.5 and/or Mono 2.6 (ie: no support for dynamic expandos).  Rob's claim of Massive being only 400 lines of code intruiged me and I wondered if something similar could be done without dynamics.</p>  <p>So, what's with the name?  Well if Massive is massive, this is "Peta" massive (it's now over 1,500 lines after all) and since it works with "Poco"s ... "PetaPoco" seemed like a fun name!!</p>  <p>PetaPoco's line count has grown to more than I originally hoped - it's not the tiny 400 lines of Massive. But check out what it can do ... it packs a lot of punch for it's size.</p>  <h3>Features at a Glance</h3>  <ul>  <li>Tiny, no dependencies... a single C# file you can easily add to any project.</li>  <li>Works with strictly undecorated POCOs, or attributed almost-POCOs.</li>  <li>Helper methods for Insert/Delete/Update/Save and IsNew</li>  <li>Paged requests automatically work out total record count and fetch a specific page.</li>  <li>Easy transaction support.</li>  <li>Better parameter replacement support, including grabbing named parameters from object properties.</li>  <li>Great performance by eliminating Linq and fast property assignment with DynamicMethod generation.</li>  <li>Includes T4 templates to automatically generate POCO classes for you.</li>  <li>The query language is SQL... no weird fluent or Linq syntaxes (yes, matter of opinion)</li>  <li>Includes a low friction SQL builder class that makes writing inline SQL <em>much</em> easier.</li>  <li>Hooks for logging exceptions, installing value converters and mapping columns to properties without attributes.</li>  <li>Works with SQL Server, SQL Server CE, MySQL, PostgreSQL and Oracle.</li>  <li>Works under .NET 3.5 or Mono 2.6 and later.</li>  <li>Experimental support for <code>dynamic</code> under .NET 4.0 and Mono 2.8</li>  <li>NUnit unit tests.</li>  <li>OpenSource (Apache License)</li>  <li>All of this in about 1,500 lines of code</li>  </ul>  <h3>Download</h3>  <p>PetaPoco is available from:</p>  <ul>  <li>NuGet - <a href="http://nuget.org/List/Packages/PetaPoco" target="_blank">http://nuget.org/List/Packages/PetaPoco</a></li>  <li>GitHub - <a href="https://github.com/toptensoftware/petapoco" target="_blank">https://github.com/toptensoftware/petapoco</a></li>  </ul>  <h3>Show Me the Code!</h3>  <p>These examples start out more verbose than they need to be but become less so as more features are   introduced... make sure you read to the bottom for the full experience.  I've explicitly referenced the PetaPoco   namespace to make it obvious what comes from where but in reality you'd probably chuck in a <code>using PetaPoco;</code>.</p>  <p>Also, all of these examples have been hand-typed and never compiled.  There are probably  typos.  If so, please <a href="http://www.toptensoftware.com/contact" target="_blank">let me know</a>.</p>  <h3>No Assembly</h3>  <p>PetaPoco is supplied as a single file - <a href="https://github.com/toptensoftware/PetaPoco/blob/master/PetaPoco/PetaPoco.cs" target="_blank">PetaPoco.cs</a>.  With no dependencies other than  what's in the GAC, just add this file to your project and you're set to go...</p>  <h3>Running Queries</h3>  <p>First define your POCOs:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Represents a record in the &quot;articles&quot; tablepublic class article{    public long article_id { get; set; }    public string title { get; set; }    public DateTime date_created { get; set; }    public bool draft { get; set; }    public string content { get; set; }}</pre></div> </div> </div>  </div>    <p>Next, create a <code>PetaPoco.Database</code> and run the query:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Create a PetaPoco database objectvar db=new PetaPoco.Database(&quot;connectionStringName&quot;);// Show all articles    foreach (var a in db.Query&lt;article&gt;(&quot;SELECT * FROM articles&quot;)){    Console.WriteLine(&quot;{0} - {1}&quot;, a.article_id, a.title);}</pre></div> </div> </div>  </div>    <p>To query a scalar:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>long count=db.ExecuteScalar&lt;long&gt;(&quot;SELECT Count(*) FROM articles&quot;);</pre></div> </div> </div>  </div>    <p>Or, to get a single record:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>var a = db.SingleOrDefault&lt;article&gt;(&quot;SELECT * FROM articles WHERE article_id=@0&quot;, 123));</pre></div> </div> </div>  </div>    <h3>Paged Fetches</h3>  <p>PetaPoco can automatically perform paged requests.</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>var result=db.Page&lt;article&gt;(1, 20, // &lt;-- page number and items per page        &quot;SELECT * FROM articles WHERE category=@0 ORDER BY date_posted DESC&quot;, &quot;coolstuff&quot;);</pre></div> </div> </div>  </div>    <p>In return you'll get a PagedFetch object:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>public class Page&lt;T&gt; where T:new(){    public long CurrentPage { get; set; }    public long ItemsPerPage { get; set; }    public long TotalPages { get; set; }    public long TotalItems { get; set; }    public List&lt;T&gt; Items { get; set; }}</pre></div> </div> </div>  </div>    <p>Behind the scenes, PetaPoco does the following:</p>  <ol>  <li>Synthesizes and executes a query to retrieve the total number of matching records</li>  <li>Modifies your original query to request just a subset of the entire record set</li>  </ol>  <p>You now have everything to display a page of data and a pager control all wrapped up in one handy   little object!</p>  <h3>Query vs Fetch</h3>  <p>The Database class has two methods for retrieving records <code>Query</code> and <code>Fetch</code>.  These are pretty  much identical except Fetch returns a List&lt;&gt; of POCO's whereas Query uses <code>yield return</code> to iterate  over the results without loading the whole set into memory.</p>  <h3>Non-query Commands</h3>  <p>To execute non-query commands, use the Execute method</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>db.Execute(&quot;DELETE FROM articles WHERE draft&lt;&gt;0&quot;);</pre></div> </div> </div>  </div>    <h3>Inserts, Updates and Deletes</h3>  <p>PetaPoco has helpers for insert, update and delete operations.</p>  <p>To insert a record, you need to specify the table and its primary key:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Create the articlevar a=new article();a.title=&quot;My new article&quot;;a.content=&quot;PetaPoco was here&quot;;a.date_created=DateTime.UtcNow;// Insert itdb.Insert(&quot;articles&quot;, &quot;article_id&quot;, a);// by now a.article_id will have the id of the new article</pre></div> </div> </div>  </div>    <p>Updates are similar:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Get a recordvar a=db.SingleOrDefault&lt;article&gt;(&quot;SELECT * FROM articles WHERE article_id=@0&quot;, 123);// Change ita.content=&quot;PetaPoco was here again&quot;;// Save itdb.Update(&quot;articles&quot;, &quot;article_id&quot;, a);</pre></div> </div> </div>  </div>    <p>Or you can pass an anonymous type to update a subset of fields.  In this case only the article's title field will be updated.</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>db.Update(&quot;articles&quot;, &quot;article_id&quot;, new { title=&quot;New title&quot; }, 123);</pre></div> </div> </div>  </div>    <p>To delete:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Delete an article extracting the primary key from a recorddb.Delete(&quot;articles&quot;, &quot;article_id&quot;, a);// Or if you already have the ID elsewheredb.Delete(&quot;articles&quot;, &quot;article_id&quot;, null, 123);</pre></div> </div> </div>  </div>    <h3>Decorating Your POCOs</h3>  <p>In the above examples, it's a pain to have to specify the table name and primary key all over the place,  so you can attach this info to your POCO:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Represents a record in the &quot;articles&quot; table[PetaPoco.TableName(&quot;articles&quot;)][PetaPoco.PrimaryKey(&quot;article_id&quot;)]public class article{    public long article_id { get; set; }    public string title { get; set; }    public DateTime date_created { get; set; }    public bool draft { get; set; }    public string content { get; set; }}</pre></div> </div> </div>  </div>    <p>Now inserts, updates and deletes get simplified to this:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Insert a recordvar a=new article();a.title=&quot;My new article&quot;;a.content=&quot;PetaPoco was here&quot;;a.date_created=DateTime.UtcNow;db.Insert(a);// Update ita.content=&quot;Blah blah&quot;;db.Update(a);// Delete itdb.Delete(a);</pre></div> </div> </div>  </div>    <p>There are also other overloads for Update and Delete:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Delete an articledb.Delete&lt;article&gt;(&quot;WHERE article_id=@0&quot;, 123);// Update an articledb.Update&lt;article&gt;(&quot;SET title=@0 WHERE article_id=@1&quot;, &quot;New Title&quot;, 123);</pre></div> </div> </div>  </div>    <p>You can also tell it to ignore certain fields:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>public class article{    [PetaPoco.Ignore]    public long SomeCalculatedFieldPerhaps    {         get; set;     }}</pre></div> </div> </div>  </div>    <p>Or, perhaps you'd like to be a little more explicit. Rather than automatically mapping all columns you can  use the ExplicitColumns attribute on the class and the Column to indicate just those columns that should be  mapped.</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Represents a record in the &quot;articles&quot; table[PetaPoco.TableName(&quot;articles&quot;)][PetaPoco.PrimaryKey(&quot;article_id&quot;)][PetaPoco.ExplicitColumns]public class article{    [PetaPoco.Column] public long article_id { get; set; }    [PetaPoco.Column] public string title { get; set; }    [PetaPoco.Column] public DateTime date_created { get; set; }    [PetaPoco.Column] public bool draft { get; set; }    [PetaPoco.Column] public string content { get; set; }}</pre></div> </div> </div>  </div>    <p>This works great with partial classes. Put all your table binding stuff in one .cs file and calculated and   other useful properties can be added in a separate file with out thinking about the data layer).</p>  <h3>Hey! Aren't there already standard attributes for decorating a POCO's database info?</h3>  <p>Well I could use them but there are so few that PetaPoco supports that I didn't want to cause confusion over what it could do.</p>  <h3>Hey! Wait a minute... they're not POCO objects!</h3>  <p>Your right, the attributes really do break the strict concept of <a href="http://en.wikipedia.org/wiki/Plain_Old_CLR_Object" target="_blank">POCO</a>,   but if you can live with that they really do make working with PetaPoco easy.</p>  <h3>T4 Template</h3>  <p>Writing all those POCO objects can soon get tedious and error prone... so PetaPoco includes a <a href="http://www.hanselman.com/blog/T4TextTemplateTransformationToolkitCodeGenerationBestKeptVisualStudioSecret.aspx" target="_blank">T4 template</a>   that can automatically write classes for all the tables in your your SQL Server, SQL Server CE, MySQL, PostgreSQL or Oracle database.</p>  <p>Using the T4 template is pretty simple.  The git repository includes three files (The NuGet package adds   these to your project automatically in the folder <code>\Models\Generated</code>).</p>  <ul>  <li>PetaPoco.Core.ttinclude - includes all the helper routines for reading the DB schema</li>  <li>PetaPoco.Generator.ttinclude - the actual template that defines what's generated</li>  <li>Database.tt - the template itself that includes various settings and includes the two other ttinclude files.</li>  </ul>  <p>A typical Database.tt file looks like this:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>&lt;#@ include file=&quot;PetaPoco.Core.ttinclude&quot; #&gt;&lt;#    // Settings    ConnectionStringName = &quot;jab&quot;;    Namespace = ConnectionStringName;    DatabaseName = ConnectionStringName;    string RepoName = DatabaseName + &quot;DB&quot;;    bool GenerateOperations = true;    // Load tables    var tables = LoadTables();#&gt;&lt;#@ include file=&quot;PetaPoco.Generator.ttinclude&quot; #&gt;</pre></div> </div> </div>  </div>    <p>To use the template:</p>  <ol>  <li>Add the three files to you C# project</li>  <li>Make sure you have a connection string and provider name set in your app.config or web.config file</li>  <li>Edit ConnectionStringName property in Records.tt (ie: change it from "jab" to the name of your connection string)</li>  <li>Save Database.tt.    </li>  </ol>  <p>All going well Database.cs should be generated with POCO objects representing all the tables in your database. To get   the project to build you'll also need to add PetaPoco.cs to your project and ensure it is set to compile (NuGet does   this for you) .</p>  <p>The template is based on the <a href="http://subsonicproject.com" target="_blank">SubSonic</a> template.  If you're familiar with its  ActiveRecord templates you'll find PetaPoco's template very similar. </p>  <h3>Automatic Select clauses</h3>  <p>When using PetaPoco, most queries start with "SELECT * FROM table".  Given that we can now grab the table   name from the POCO object using the TableName attribute, there's no reason we can't automatically  generate this part of the select statement.</p>  <p>If you run a query that doesn't start with "SELECT", PetaPoco will automatically put it in. So this:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Get a recordvar a=db.SingleOrDefault&lt;article&gt;(&quot;SELECT * FROM articles WHERE article_id=@0&quot;, 123);</pre></div> </div> </div>  </div>    <p>can be shortened to this:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Get a recordvar a=db.SingleOrDefault&lt;article&gt;(&quot;WHERE article_id=@0&quot;, 123);</pre></div> </div> </div>  </div>    <p>PetaPoco doesn't actually generate "SELECT *"... rather it picks the column names of the POCO  and just queries for those columns.</p>  <h3>IsNew and Save Methods</h3>  <p>Sometimes you have a POCO and you want to know if it's already in the database.  Since we have the primary key all we need to do is check if that property has been set to something other than the default value.</p>  <p>So to test if a record is new:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Is this a new record if (db.IsNew(a)){    // Yes it is...}</pre></div> </div> </div>  </div>    <p>And related, there's a Save method that will work out whether to Insert or Update</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>// Save a new or existing recorddb.Save(a);</pre></div> </div> </div>  </div>    <h3>Transactions</h3>  <p>Transactions are pretty simple:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>using (var scope=db.Transaction){    // Do transacted updates here    // Commit    scope.Complete();}</pre></div> </div> </div>  </div>    <p>Transactions can be nested, so you can call out to other methods with their own nested transaction scopes  and the whole lot will be wrapped up in a single transaction.  So long as all nested transcaction scopes   are completed the entire root level transaction is committed, otherwise everything is rolled back.</p>  <p>Note: for transactions to work, all operations need to use the same instance of the PetaPoco database   object.  So you'll probably want to use a per-http request, or per-thread IOC container to serve up a shared  instance of this object.  Personally <a href="http://structuremap.net" target="_blank">StructureMap</a> is my favourite for this.</p>  <h3>But where's the LINQ stuff?</h3>  <p>There isn't any.  I've used Linq with Subsonic for a long time now and more and more I find myself descending  into <a href="http://subsonicproject.com/docs/CodingHorror" target="_blank">CodingHorror</a> for things that:</p>  <ul>  <li>can't be done in Linq easily</li>  <li>work in .NET but not under Mono (especially Mono 2.6)</li>  <li>don't perform efficiently.  Eg: Subsonic's activerecord.SingleOrDefault(x=x.id==123) seems to be about 20x  slower than CodingHorror. (See <a href="https://github.com/subsonic/SubSonic-3.0/issues/258" target="_blank">here</a>)</li>  </ul>  <p>Now that I've got CodingHorror all over the place it bugs me that half the code is Linq and half is SQL.</p>  <p>Also, I've realized that for me the most annoying thing about SQL directly in the code is not the fact that it's   SQL but that it's nasty to format nicely and to build up those SQL strings.</p>  <p>So...</p>  <h3>PetaPoco's SQL Builder</h3>  <p>There's been plenty of attempts at building fluent type API's for building SQL.  This is my version and it's really  basic.    </p>  <p>The point of this is to make formatting the SQL strings easy and to use proper parameter replacements  to protect from SQL injection. This is not an attempt to ensure the SQL is syntactically correct, nor is it  trying to hold anyone's hand with intellisense.</p>  <p>Here's its most basic form:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>var id=123;var a=db.Query&lt;article&gt;(PetaPoco.Sql.Builder    .Append(&quot;SELECT * FROM articles&quot;)    .Append(&quot;WHERE article_id=@0&quot;, id))</pre></div> </div> </div>  </div>    <p>Big deal right?  Well what's cool about this is that the parameter indicies are specific to each <code>.Append</code> call:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>var id=123;var a=db.Query&lt;article&gt;(PetaPoco.Sql.Builder    .Append(&quot;SELECT * FROM articles&quot;)    .Append(&quot;WHERE article_id=@0&quot;, id)    .Append(&quot;AND date_created&lt;@0&quot;, DateTime.UtcNow))</pre></div> </div> </div>  </div>    <p>You can also conditionally build SQL.    </p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>var id=123;var sql=PetaPoco.Sql.Builder    .Append(&quot;SELECT * FROM articles&quot;)    .Append(&quot;WHERE article_id=@0&quot;, id);if (start_date.HasValue)    sql.Append(&quot;AND date_created&gt;=@0&quot;, start_date.Value);if (end_date.HasValue)    sql.Append(&quot;AND date_created&lt;=@0&quot;, end_date.Value);var a=db.Query&lt;article&gt;(sql)</pre></div> </div> </div>  </div>    <p>Note that each append call uses parameter @0?  PetaPoco builds the full list of arguments and   updates the parameter indices internally for you.</p>  <p>You can also use named parameters and it will look for an appropriately named property on  any of the passed arguments</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>sql.Append(&quot;AND date_created&gt;=@start AND date_created&lt;=@end&quot;,                 new                 {                     start=DateTime.UtcNow.AddDays(-2),                     end=DateTime.UtcNow                 }            );</pre></div> </div> </div>  </div>    <p>With both numbered and named parameters, if any of the parameters can't be resolved   an exception is thrown.</p>  <p>There are also methods for building common SQL stuff:</p>  <div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>var sql=PetaPoco.Sql.Builder()            .Select(&quot;*&quot;)            .From(&quot;articles&quot;)            .Where(&quot;date_created &lt; @0&quot;, DateTime.UtcNow)            .OrderBy(&quot;date_created DESC&quot;);</pre></div> </div> </div>  </div>    <h3>SQL Command Tracking</h3>  <p>Sometime it's useful to be able to see what SQL was just executed.  PetaPoco exposes these three properties:</p>  <ul>  <li>LastSQL - pretty obvious</li>  <li>LastArgs - an object[] array of all arguments passed</li>  <li>LastCommand - a string that shows the SQL and the arguments</li>  </ul>  <p>Watching the LastCommand property in the debugger makes it easy to see what just happened!</p>  <h3>OnException Handler Routine</h3>  <p>PetaPoco wraps all SQL command invocations in try/catch statements. Any exceptions are passed  to the virtual OnException method.  By logging these exceptions (or setting a breakpoint on this method)  you can easily track where an when there are problems with your SQL.</p>  <h3>More</h3>  <p>The covers most of the basics of working with PetaPoco, but for more please <a href="http://www.toptensoftware.com/petapoco#">read these blog posts about PetaPoco</a>.</p>                    <p>&nbsp;</p>    </div></blockquote>    <div class="posterous_quote_citation">via <a href="http://www.toptensoftware.com/petapoco/">toptensoftware.com</a></div> <p></p></div> <p style="font-size: 10px;"> <a href="http://posterous.com">Posted via email</a>  from <a href="http://blog.solutionrevolution.net/topten-software-petapoco">solution revolution</a> </p> </div>