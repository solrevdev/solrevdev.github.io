---
layout: post
title: The Most Popular Pub Names [feedly]
date: '2013-07-30T19:12:00.001+01:00'
author: John Smith
tags:
modified_time: '2013-07-30T19:14:32.309+01:00'
blogger_id: tag:blogger.com,1999:blog-31446756.post-2104707741867009107
blogger_orig_url: https://solrevdev.com/2013/07/the-most-popular-pub-names-feedly.html
---

<div>      <style>  BODY  {  margin:1em;  font-size: 16px;  background-repeat: repeat;  line-height: 1.5em;  color: #262626;  }  a  {  color: #82BD1A;  }  table { font: inherit; }  .source {  color : #909090;  font-size : 14px;  }  .article  {  padding : 1em;  background-color: #eaeded;  color : #404040;  margin-top : 1.5em;  }  .visit  {  border-radius : 4px;  background-color: #CFCFCF;  text-align : center;  padding : 8px;  }  .visit a  {  text-decoration : none;  color : #666;  }  .header   {  padding-top : 0.3em;  padding-bottom : 1.5em;  font-size : 28px;  line-height : 1.2em;  font-weight : bold;  }  .footer   {  padding-top : 3em;  padding-bottom : 6em;  color : #444444;  text-align : center;  }  </style>      This is what mongodb and big data is perfect for. especially if you are a Brit. Genius.</div><div><br></div><div>Cheers!<br>     <br>     <div class="article">  <div class="source">  Shared via <a href="http://bit.ly/SA6Efh">feedly</a> // published on The MongoDB NoSQL Database Blog // <a href="http://blog.mongodb.org/post/56876800071">visit site</a>  </div>  <div class="header">  <b>The Most Popular Pub Names</b>  </div>  <div>  <p><em>By Ross Lawley, MongoEngine maintainer and Scala Engineer at 10gen</em>  </p><p>Earlier in the year I gave a talk at <a href="http://www.10gen.com/events/mongodb-london-2013">MongoDB London</a> about the different aggregation options with MongoDB. The topic recently came up again in conversation at a user group, so I thought it deserved a blog post.  </p><h4>Gathering ideas for the talk</h4>  <p>I wanted to give a more interesting aggregation talk than the standard "counting words in text&quot;, and as the <a href="http://docs.mongodb.org/manual/core/aggregation/">aggregation framework</a> gained shiny <a href="http://docs.mongodb.org/manual/core/2dsphere/">2dsphere geo</a> support in <a href="http://docs.mongodb.org/manual/release-notes/2.4/#new-geospatial-indexes-with-geojson-and-improved-spherical-geometry">2.4</a>, I figured I'd use that. I just needed a topic…  </p><h5>What is top of mind for us Brits?</h5>  <p>Two things immediately sprang to mind: <strong>weather</strong> and <strong>beer</strong>.  </p><p>I opted to focus on something close to my heart: <strong>beer</strong> :) But what to aggregate about beer? Then I remembered an old pub quiz favourite…  </p><p><strong>What is the most popular pub name in the UK?</strong>  </p><p>I know there is some great open data, including a wealth of information on pubs available from the awesome <a href="http://www.openstreetmap.org/">open street map</a> project. I just need to get at it and happily the <a href="http://www.overpass-api.de">Overpass-api</a> provides a simple "xapi&quot; interface for OSM data. All I needed was anything tagged with <code>amenity=pub</code> within in the bounds of the UK and with their xapi interface this is as simple as a wget:  </p><p><code><a href="http://www.overpass-api.de/api/xapi?*"></a><a href="http://www.overpass-api.de/api/xapi?*">http://www.overpass-api.de/api/xapi?*</a>[amenity=pub][bbox=-10.5,49.78,1.78,59]</code>  </p><p>Once I had an osm file I used the <a href="http://imposm.org/">imposm python library</a> to parse the xml and then convert it to following GeoJSON format:  </p><pre>{    &quot;_id&quot; : 451152,    &quot;amenity&quot; : &quot;pub&quot;,    &quot;name&quot; : &quot;The Dignity&quot;,    &quot;addr:housenumber&quot; : &quot;363&quot;,    &quot;addr:street&quot; : &quot;Regents Park Road&quot;,    &quot;addr:city&quot; : &quot;London&quot;,    &quot;addr:postcode&quot; : &quot;N3 1DH&quot;,    &quot;toilets&quot; : &quot;yes&quot;,    &quot;toilets:access&quot; : &quot;customers&quot;,    &quot;location&quot; : {        &quot;type&quot; : &quot;Point&quot;,        &quot;coordinates&quot; : [-0.1945732, 51.6008172]    }  }</pre>  <p>Then it was a case of simply inserting it as a document into MongoDB. I quickly noticed that the data needed a little cleaning, as I was seeing duplicate pub names, for example: "The Red Lion&quot; and "Red Lion&quot;. Because I wanted to make a wordle I normalised all the pub names.  </p><p>If you want to know more about the importing process, the full loading code is available on github: <a href="https://github.com/rozza/pubnames/blob/master/osm2mongo.py">osm2mongo.py</a>  </p><h4>Top pub names</h4>  <p>It turns out finding the most popular pub names is very simple with the aggregation framework. Just group by the name and then sum up all the occurrences. To get the top five most popular pub names we sort by the summed value and then limit to 5:  </p><div>  <div>  <pre>db.pubs.aggregate([    {&quot;$group&quot;:       {&quot;_id&quot;: &quot;$name&quot;,        &quot;value&quot;: {&quot;$sum&quot;: 1}       }    },    {&quot;$sort&quot;: {&quot;value&quot;: -1}},    {&quot;$limit&quot;: 5}  ]);  </pre>  </div>  <div>For the whole of the UK this returns:<ol><li>The Red Lion  </li><li>The Royal Oak  </li><li>The Crown  </li><li>The White Hart  </li><li>The White Horse  </li></ol></div>  </div>  <p><img src="http://media.tumblr.com/3ba15870032a0dde2ce278aee76764c4/tumblr_inline_mqr62eACa61qz4rgp.png" alt="image">  </p><h4>Top pub names near you</h4>  <p>At MongoDB London I thought that was too easy, so filtered to find the top pub names near the conference and showing off some of the geo functionality that became available in MongoDB 2.4. To limit the result set match and ensure the location is within a 2 mile radius by using <code>$centreSphere</code>. Just provide the coordinates <code>[ ,  ]</code> and a radius of roughly 2 miles (3959 is approximately the radius of the earth, so divide it by 2):  </p><pre>db.pubs.aggregate([      { &quot;$match&quot; : { &quot;location&quot;:                   { &quot;$within&quot;:                     { &quot;$centerSphere&quot;: [[-0.12, 51.516], 2 / 3959] }}}      },      { &quot;$group&quot; :         { &quot;_id&quot; : &quot;$name&quot;,           &quot;value&quot; : { &quot;$sum&quot; : 1 } }      },      { &quot;$sort&quot; : { &quot;value&quot; : -1 } },      { &quot;$limit&quot; : 5 }    ]);  </pre>  <h4>What about where I live?</h4>  <p>At the conference I looked the most popular pub name near the conference. Thats great if you happen to live in the centre of London but what about everyone else in the UK? So for this blog post I decided to update the demo code and make it dynamic based on where you live.  </p><p>See: <a href="http://pubnames.rosslawley.co.uk">pubnames.rosslawley.co.uk</a>  </p><p>Apologies for those outside the UK - the demo app doesn't have data for the whole world - its surely possible to do.  </p><h4>Cheers</h4>  <p>All the code is available in my repo on <a href="https://github.com/rozza/pubnames">github</a> including the bson file of the pubs and the wordle code - so fork it and start playing with MongoDB's great geo features!  </p></div>  <br>  <div class="visit">  <a href="http://blog.mongodb.org/post/56876800071">Visit website</a>  </div>  </div>  <div class="footer">  Sent via <a href="http://bit.ly/SA6Efh">feedly</a> // A news reader for creative minds.  </div>    </div>