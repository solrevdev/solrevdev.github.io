---
layout: post
title: dapper-dot-net - Simple SQL object mapper for SQL Server - Google Project Hosting
date: '2011-04-10T23:59:00.001+01:00'
author: solrevdev
tags: 
modified_time: '2011-04-10T23:59:27.698+01:00'
blogger_id: tag:blogger.com,1999:blog-31446756.post-4711851858770743605
blogger_orig_url: http://www.solrevdev.com/2011/04/dapper-dot-net-simple-sql-object-mapper.html
---

<div class='posterous_autopost'><div class="posterous_bookmarklet_entry"> <blockquote><td>  <h3><a name="Dapper_-_a_simple_object_mapper_for_.Net"></a>Dapper - a simple object mapper for .Net<a href="http://code.google.com/p/dapper-dot-net#Dapper_-_a_simple_object_mapper_for_.Net"></a></h3><h3><a name="Features"></a>Features<a href="http://code.google.com/p/dapper-dot-net#Features"></a></h3><p>Dapper is a <a href="http://code.google.com/p/dapper-dot-net/source/browse/SqlMapper.cs" rel="nofollow">single file</a> you can drop in to your project that will extend your <tt>IDbConnection</tt> interface. </p><p>It provides 3 helpers:  </p><h3><a name="Execute_a_query_and_map_the_results_to_a_strongly_typed_List"></a>Execute a query and map the results to a strongly typed List<a href="http://code.google.com/p/dapper-dot-net#Execute_a_query_and_map_the_results_to_a_strongly_typed_List"></a></h3><p><tt>public static List&lt;T&gt; ExecuteMapperQuery&lt;T&gt;(this IDbConnection cnn, string sql, object param = null, SqlTransaction transaction = null)</tt> </p><p>Example usage: </p><div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>public class Dog{    public int? Age { get; set; }    public Guid Id { get; set; }    public string Name { get; set; }    public float? Weight { get; set; }    public int IgnoredProperty { get { return 1; } }}                        var guid = Guid.NewGuid();var dog = connection.ExecuteMapperQuery&lt;Dog&gt;(&quot;select Age = @Age, Id = @Id&quot;, new { Age = (int?)null, Id = guid });            dog.Count()    .IsEqualTo(1);dog.First().Age    .IsNull();dog.First().Id    .IsEqualTo(guid);</pre></div> </div> </div>  </div>  <h3><a name="Execute_a_query_and_map_it_to_a_list_of_dynamic_objects"></a>Execute a query and map it to a list of dynamic objects<a href="http://code.google.com/p/dapper-dot-net#Execute_a_query_and_map_it_to_a_list_of_dynamic_objects"></a></h3><p><tt>public static List&lt;dynamic&gt; ExecuteMapperQuery (this IDbConnection cnn, string sql, object param = null, SqlTransaction transaction = null)</tt> </p><p>This method will execute SQL and return a dynamic list.  </p><p>Example usage:  </p><div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre> var rows = connection.ExecuteMapperQuery(&quot;select 1 A, 2 B union all select 3, 4&quot;);((int)rows[0].A)   .IsEqualTo(1);((int)rows[0].B)   .IsEqualTo(2);((int)rows[1].A)   .IsEqualTo(3);((int)rows[1].B)    .IsEqualTo(4);</pre></div> </div> </div>  </div>  <h3><a name="Execute_a_Command_that_returns_no_results"></a>Execute a Command that returns no results<a href="http://code.google.com/p/dapper-dot-net#Execute_a_Command_that_returns_no_results"></a></h3><p><tt>public static int ExecuteMapperCommand(this IDbConnection cnn, string sql, object param = null, SqlTransaction transaction = null)</tt> </p><p>Example usage: </p><div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>connection.ExecuteMapperCommand(@&quot;  set nocount on   create table #t(i int)   set nocount off   insert #t   select @a a union all select @b   set nocount on   drop table #t&quot;, new {a=1, b=2 })   .IsEqualTo(2);</pre></div> </div> </div>  </div>  <h3><a name="Performance"></a>Performance<a href="http://code.google.com/p/dapper-dot-net#Performance"></a></h3><p>A key feature of Dapper is performance. The following metrics show how long it takes to execute 500 <tt>SELECT</tt> statements against a DB and map the data returned to objects. </p><p>The performance tests are broken in to 3 lists,  </p><p># POCO serialization for frameworks that support pulling static typed objects from the DB. Using raw SQL. # Dynamic serialization for frameworks that support returning <tt>dynamic</tt> lists of objects.  # Typical framework usage. Often typical framework usage differs from the optimal usage performance wise. Often it will not involve writing SQL.   </p><h3><a name="Performance_of_SELECT_mapping_over_500_iterations_-_POCO_seriali"></a>Performance of <tt>SELECT</tt> mapping over 500 iterations - POCO serialization<a href="http://code.google.com/p/dapper-dot-net#Performance_of_SELECT_mapping_over_500_iterations_-_POCO_seriali"></a></h3><p></p><table><tr><td style="border: 1px solid #ccc; padding: 5px;"> <strong>Method</strong> </td><td style="border: 1px solid #ccc; padding: 5px;"> <strong>Duration</strong> </td><td style="border: 1px solid #ccc; padding: 5px;"> <strong>Remarks</strong> </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> Hand coded (using a <tt>SqlDataReader</tt>) </td><td style="border: 1px solid #ccc; padding: 5px;"> 47ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> Dapper <tt>ExecuteMapperQuery&lt;Post&gt;</tt> </td><td style="border: 1px solid #ccc; padding: 5px;"> 49ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> <a href="http://www.toptensoftware.com/petapoco/" rel="nofollow">PetaPoco</a> </td><td style="border: 1px solid #ccc; padding: 5px;"> 52ms </td><td style="border: 1px solid #ccc; padding: 5px;"> <a href="http://www.toptensoftware.com/Articles/94/PetaPoco-More-Speed" rel="nofollow">Can be faster</a> </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> BLToolkit </td><td style="border: 1px solid #ccc; padding: 5px;"> 80ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> SubSonic <a href="http://www.subsonicproject.com/docs/CodingHorror" rel="nofollow">CodingHorror</a> </td><td style="border: 1px solid #ccc; padding: 5px;"> 107ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> NHibernate SQL </td><td style="border: 1px solid #ccc; padding: 5px;"> 104ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> Linq 2 SQL <tt>ExecuteQuery</tt>  </td><td style="border: 1px solid #ccc; padding: 5px;"> 181ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> Entity framework <tt>ExecuteStoreQuery</tt> </td><td style="border: 1px solid #ccc; padding: 5px;"> 631ms </td></tr> </table><p></p><h3><a name="Performance_of_SELECT_mapping_over_500_iterations_-_dynamic_seri"></a>Performance of <tt>SELECT</tt> mapping over 500 iterations - dynamic serialization<a href="http://code.google.com/p/dapper-dot-net#Performance_of_SELECT_mapping_over_500_iterations_-_dynamic_seri"></a></h3><p></p><table><tr><td style="border: 1px solid #ccc; padding: 5px;"> <strong>Method</strong> </td><td style="border: 1px solid #ccc; padding: 5px;"> <strong>Duration</strong> </td><td style="border: 1px solid #ccc; padding: 5px;"> <strong>Remarks</strong> </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> Dapper <tt>ExecuteMapperQuery (dynamic)</tt> </td><td style="border: 1px solid #ccc; padding: 5px;"> 52ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> <a href="http://blog.wekeroad.com/helpy-stuff/and-i-shall-call-it-massive" rel="nofollow">Massive</a> </td><td style="border: 1px solid #ccc; padding: 5px;"> 52ms </td></tr> </table><p></p><h3><a name="Performance_of_SELECT_mapping_over_500_iterations_-_typical_usag"></a>Performance of <tt>SELECT</tt> mapping over 500 iterations - typical usage<a href="http://code.google.com/p/dapper-dot-net#Performance_of_SELECT_mapping_over_500_iterations_-_typical_usag"></a></h3><p></p><table><tr><td style="border: 1px solid #ccc; padding: 5px;"> <strong>Method</strong> </td><td style="border: 1px solid #ccc; padding: 5px;"> <strong>Duration</strong> </td><td style="border: 1px solid #ccc; padding: 5px;"> <strong>Remarks</strong> </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> Linq 2 SQL <tt>CompiledQuery</tt> </td><td style="border: 1px solid #ccc; padding: 5px;"> 81ms </td><td style="border: 1px solid #ccc; padding: 5px;"> Not super typical involves complex code </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> NHibernate HQL </td><td style="border: 1px solid #ccc; padding: 5px;"> 118ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> Linq 2 SQL </td><td style="border: 1px solid #ccc; padding: 5px;"> 559ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> Entity framework </td><td style="border: 1px solid #ccc; padding: 5px;"> 859ms </td></tr> <tr><td style="border: 1px solid #ccc; padding: 5px;"> SubSonic <tt>ActiveRecord.SingleOrDefault</tt> </td><td style="border: 1px solid #ccc; padding: 5px;"> 3619ms </td></tr> </table><p></p><p><strong></strong><strong> Performance benchmarks are available here: <a href="http://code.google.com/p/dapper-dot-net/source/browse/PerformanceTests.cs" rel="nofollow">http://code.google.com/p/dapper-dot-net/source/browse/PerformanceTests.cs</a> , Feel free to submit patches that include other ORMs - </strong>when running benchmarks, be sure to compile in Release and not attach a debugger (ctrl F5)<strong> </strong></p><h3><a name="Parameterized_queries"></a>Parameterized queries<a href="http://code.google.com/p/dapper-dot-net#Parameterized_queries"></a></h3><p>Parameters are passed in as anonymous classes. This allow you to name your parameters easily and gives you the ability to simply cut-and-paste SQL snippets and run them in Query analyzer. </p><div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>new {A = 1, B = &quot;b&quot;} // A will be mapped to the param @A, B to the param @B</pre></div> </div> </div>  </div>  <h3><a name="Advanced_features"></a>Advanced features<a href="http://code.google.com/p/dapper-dot-net#Advanced_features"></a></h3><p>Dapper allow you to pass in <tt>IEnumerable&lt;int&gt;</tt> and will automatically parameterize your query.  </p><p>For example:  </p><p><tt>connection.ExecuteMapperQuery&lt;int&gt;("select * from (select 1 as Id union all select 2 union all select 3) as X where Id in @Ids", new { Ids = new int[] { 1, 2, 3 });</tt>  </p><p>Will be translated to:  </p><div class="CodeRay">  <div class="code"><div class="CodeRay"> <div class="code"><pre>select * from (select 1 as Id union all select 2 union all select 3) as X where Id in (@Ids1, @Ids2, @Ids3)&quot; // @Ids1 = 1 , @Ids2 = 2 , @Ids2 = 3</pre></div> </div> </div>  </div>  <h3><a name="Limitations_and_caveats"></a>Limitations and caveats<a href="http://code.google.com/p/dapper-dot-net#Limitations_and_caveats"></a></h3><p>Dapper caches information about every query it runs, this allow it to materialize objects quickly and process parameters quickly. The current implementation caches this information in two <tt>ConcurrentDictionary</tt> objects. These objects are never flushed. <strong></strong>If<strong></strong> you are generating SQL strings on the fly without using parameters it is possible you will hit memory issues. We may convert the dictionaries to an LRU Cache. </p><p>Dapper's simplicity means that many feature that ORMs ship with are stripped out, there is no identity map, there are no helpers for update / select and so on.  </p><p>Dapper does not manage your connection lifecycle, it assumes the connection it gets is open AND has no existing datareaders enumerating (unless MARS is enabled)  </p><h3><a name="Who_is_using_this?"></a>Who is using this?<a href="http://code.google.com/p/dapper-dot-net#Who_is_using_this?"></a></h3><p>Dapper is in production use at <a href="http://stackoverflow.com" rel="nofollow">Stack Overflow</a>  </p>  </td></blockquote>    <div class="posterous_quote_citation">via <a href="http://code.google.com/p/dapper-dot-net/">code.google.com</a></div> <p>Quicker than subsonic.... a couple of other similar ORM's like this. more to follow</p></div> <p style="font-size: 10px;"> <a href="http://posterous.com">Posted via email</a>  from <a href="http://solrev.posterous.com/dapper-dot-net-simple-sql-object-mapper-for-s">solution revolution</a> </p> </div>